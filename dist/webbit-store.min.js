!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("lodash"),require("redux")):"function"==typeof define&&define.amd?define(["exports","lodash","redux"],r):(e=e||self,r(e.WebbitStore={},e._,e.Redux))}(this,function(e,r,t){"use strict";function o(e){return{type:_,payload:{providerName:e}}}function n(e){return{type:f,payload:{providerName:e}}}function i(e,r){return{type:d,payload:{providerName:e,sourceChanges:r}}}function u(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function s(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function c(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?s(Object(t),!0).forEach(function(r){u(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}class a{static get typeName(){return null}static get settingsDefaults(){return{}}get settings(){return{}}onSettingsChange(e){}updateFromProvider(){}updateFromDashboard(){}getType(e){return r.isString(e)?"string":r.isNumber(e)?"number":r.isBoolean(e)?"boolean":r.isArray(e)?"Array":r.isNull(e)?"null":null}}var _="INIT_SOURCES",f="REMOVE_SOURCES",d="SOURCES_CHANGED",p=e=>e.split("/").map(e=>r.camelCase(e)).join("/"),v={sources:{}},l=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:v,t=arguments.length>1?arguments[1]:void 0;switch(t.type){case _:var o=c({},e.sources[t.payload.providerName]);return r.isEmpty(o)&&(o={__normalizedKey__:void 0,__fromProvider__:!1,__key__:void 0,__value__:void 0,__sources__:{}}),c({},c({},e.sources));case d:var{sourceChanges:sourceChanges,providerName:providerName}=t.payload,n=c({},e.sources[providerName]);return r.isEmpty(n)&&(n={__normalizedKey__:void 0,__fromProvider__:!1,__key__:void 0,__value__:void 0,__sources__:{}}),r.forEach(sourceChanges,(e,r)=>{var t=r.split("/");var o=p(r);var i=o.split("/");var u=n.__sources__;i.forEach((r,o)=>{var n=r in u;n||(u[r]={__fromProvider__:!1,__normalizedKey__:i.slice(0,o+1).join("/"),__key__:t.slice(0,o+1).join("/"),__value__:void 0,__sources__:{}});i.length-1===o?(u[r].__fromProvider__=!0,void 0!==e&&(u[r].__value__=e)):u=u[r].__sources__})}),c({},c({},e.sources));case"CLEAR_SOURCES":return t.payload.providerName in e.sources?c({},c({},e.sources)):e;case f:var i=c({},e.sources);return delete i[t.payload.providerName],c({});default:return e}},y=t.createStore(l);class h{constructor(e,r){this.providerName=r,this.provider=e,this.sourceUpdates={},this.provider.updateFromProvider(this._updateSource.bind(this)),this.interval=setInterval(this._sendUpdates.bind(this),100)}_disconnect(){clearTimeout(this.interval)}_updateSource(e,r){void 0===this.sourceUpdates[e]?this.sourceUpdates[e]={first:r}:this.sourceUpdates[e].last=r}subscribe(e,r,t){var o=y.subscribe(()=>{r(this.getSource(e))});return t&&r(this.getSource(e)),o}getSource(e){e=e||"";var t=this.getRawSource(e);if(t){var o=t.__value__,n=t.__sources__,i=this.provider;if(Object.keys(n).length>0){var u={};return r.forEach(n,(e,r)=>{var t=this.getSource(e.__key__);Object.defineProperty(u,r,{get(){return t},set(r){var t=e.__key__;"string"==typeof t&&i&&i.updateFromDashboard(t,r)}})}),u}return"boolean"==typeof o?o:"number"==typeof o?o:"string"==typeof o?o:o instanceof Array?[...o]:{}}}getRawSource(e){e=e||"";var r=y.getState().sources[this.providerName];if(void 0===r)return null;var t=p(e).split("/"),o=r.__sources__;for(var n in t){var i=t[n];if(t.length-1===parseInt(n))return i in o?o[i]:null;if(!(i in o))return null;o=o[i].__sources__}return null}_sendUpdates(){if(0!==Object.keys(this.sourceUpdates).length){var e={},t={};r.forEach(this.sourceUpdates,(r,o)=>{e[o]=r.first;"last"in r&&(t[o]=r.last)}),y.dispatch(i(this.providerName,e)),Object.keys(t).length>0&&setTimeout(()=>{y.dispatch(i(this.providerName,t))}),this.sourceUpdates={}}}}var g={},m={},b={},S=[],O=e=>e in g,P=e=>g[e],j=(e,r)=>{r=r||e;if(O(r)||!x(r)||!U(e))return;g[r]=new h(R(r),r);y.dispatch(o(r))},N=e=>{if(!O(e))return;var r=P(e);r._disconnect();y.dispatch(n(e));delete g[e]},E=e=>{var{typeName:typeName}=e;if(U(typeName))return;"SourceProvider"===Object.getPrototypeOf(e).name&&(m[typeName]=e)},U=e=>e in m,k=(e,r,t)=>{t=t||{};"string"!=typeof r&&(r=e);if(!U(e)||x(r))return null;var o=m[e];b[r]=new o(c({},o.settingsDefaults));j(e,r);S.forEach(e=>{e(r)});return b[r]},w=e=>{if("function"!=typeof e)return;S.push(e)},C=e=>{if(!x(providerType))return;delete b[e];N(e)},R=e=>b[e],D=()=>Object.keys(m),T=()=>Object.keys(b),x=e=>e in b,A=()=>y.getState(),M=a,I=h;e.SourceManager=I,e.SourceProvider=M,e.addSourceProvider=k,e.addSourceProviderType=E,e.getSourceManager=P,e.getSourceProvider=R,e.getSourceProviderNames=T,e.getSourceProviderTypeNames=D,e.getState=A,e.hasSourceManager=O,e.hasSourceProvider=x,e.hasSourceProviderType=U,e.removeSourceProvider=C,e.sourceProviderAdded=w,Object.defineProperty(e,"__esModule",{value:!0})});
